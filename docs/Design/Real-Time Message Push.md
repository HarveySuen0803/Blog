# Real-Time Message Push

消息推送是一种主动的通信方式，服务器向客户端发送实时更新或通知，而无需客户端主动请求。这种机制广泛应用于各种应用程序，如移动应用、网页应用、桌面应用等，以提供即时的通知和更新。

消息推送的类型：

- 通知消息（Notification Message）：主要用于提醒用户，如新邮件通知、社交媒体提醒等。通常包含标题、正文和可选的动作按钮。
- 数据消息（Data Message）：主要用于在后台传输数据，客户端接收到消息后自行处理，不会直接展示给用户。

# Short Polling

短轮询（Short Polling）是一种客户端定期向服务器发送请求，以检查是否有新数据的方法。每隔固定的时间间隔，客户端会发送一次请求，即使服务器没有新数据，服务器也会立即响应。

![](https://note-sun.oss-cn-shanghai.aliyuncs.com/image/202407260839025.png)

优点

- 实现简单，易于理解和部署。
- 不需要保持长时间的连接。

缺点

- 可能存在较大的延迟，因为客户端在两次轮询之间不会收到新数据。
- 频繁的请求可能增加服务器的负载和网络流量。

# Long Polling

长轮询（Long Polling）是一种改进的轮询方法，客户端向服务器发送请求后，如果服务器没有新数据，会保持连接直到有新数据或超时。服务器在有新数据时立即响应客户端，如果超时则返回空响应，客户端再立即发起下一次请求。

![](https://note-sun.oss-cn-shanghai.aliyuncs.com/image/202407260854234.png)

优点

- 减少了延迟，客户端可以更快地收到新数据。
- 减少了无效请求，降低了服务器的负载和网络流量。

缺点

- 需要保持长时间的连接，可能增加资源消耗。
- 在高并发场景下，可能会有大量的长时间连接需要管理。

# Server-Sent Events

Server-Sent Events (SSE) 是一种允许服务器向客户端推送实时更新的技术。它基于 HTTP 协议，通过一个持久的单向连接，服务器可以持续不断地向客户端发送数据。SSE 是 HTML5 的一部分，适用于需要实时更新的应用场景，如新闻推送、股票行情、聊天应用等。

SSE 是基于 HTTP 协议的长连接，服务器可以通过这个持久的连接不断地向客户端推送数据。

1. 客户端连接: 客户端使用 EventSource 对象向服务器发起一个 HTTP 请求。
2. 服务器响应: 服务器接收到请求后，保持这个连接打开，并通过 text/event-stream MIME 类型发送数据。
3. 数据推送: 服务器可以在这个持久连接上不断地发送数据，客户端会实时接收到这些数据。
4. 自动重连: 如果连接断开，客户端的 EventSource 对象会自动尝试重新连接。

![](https://note-sun.oss-cn-shanghai.aliyuncs.com/image/202407260854240.png)

SSE 的特点

- 单向通信: 服务器向客户端推送数据，客户端无法通过相同的连接向服务器发送数据。
- 基于 HTTP/1.1: 使用标准的 HTTP 协议，易于实现和部署。
- 自动重连: 客户端在连接断开时会自动尝试重新连接。
- 文本数据: SSE 主要用于传输文本数据，通常是 UTF-8 编码。

SSE 与其他技术的比较

- 与 WebSocket: WebSocket 是全双工通信，适用于需要双向实时通信的场景，如在线游戏、聊天应用。SSE 是单向通信，适用于服务器向客户端推送数据的场景。
- 与 HTTP/2 Server Push: HTTP/2 Server Push 允许服务器在客户端请求之前推送资源，适用于预加载资源。SSE 专注于实时数据推送。

SSE 的应用场景

- 实时通知: 如新闻推送、天气预报更新。
- 股票行情: 实时推送股票价格和市场动态。
- 社交媒体更新: 推送好友动态、评论、点赞等通知。
- 实时监控: 推送服务器状态、系统日志等信息。

SSE 的优点

- 简单易用: 基于 HTTP 协议，易于实现和部署。
- 自动重连: 客户端在连接断开时会自动尝试重新连接。
- 低延迟: 适用于需要实时更新的场景。

SSE 的缺点

- 单向通信: 仅支持服务器向客户端推送数据，客户端无法通过相同的连接向服务器发送数据。
- 浏览器兼容性: 虽然大多数现代浏览器都支持 SSE，但仍需注意一些旧浏览器的兼容性。

# WebSocket

WebSocket 是一种在单个 TCP 连接上进行全双工通信的协议。它设计用于在客户端（通常是浏览器）和服务器之间进行长时间的双向通信。WebSocket 连接在初次连接时通过 HTTP 升级握手从 HTTP 协议切换到 WebSocket 协议，从而实现持续的双向数据传输。

![](https://note-sun.oss-cn-shanghai.aliyuncs.com/image/202407260853077.png)

WebSocket 的特点

- 全双工通信: 客户端和服务器可以同时发送和接收消息。
- 低延迟: 适用于需要实时更新的应用，如聊天应用、在线游戏等。
- 长连接: 连接一旦建立，可以持续保持，直到显式关闭。
- 轻量级: 相比 HTTP 轮询，WebSocket 的通信开销更小。

WebSocket 的应用场景

- 即时通讯: 如聊天应用、视频会议。
- 在线游戏: 实时游戏数据传输。
- 实时数据更新: 股票行情、体育比分、新闻推送。
- 协作工具: 实时协作文档、白板应用。

WebSocket 的优点

- 实时性强: 适用于需要实时更新的应用。
- 低延迟: 相比 HTTP 轮询，WebSocket 的通信开销更小，延迟更低。
- 全双工通信: 客户端和服务器可以同时发送和接收消息。

WebSocket 的缺点

- 复杂性: 实现和维护 WebSocket 连接比传统的 HTTP 请求复杂。
- 资源占用: 长时间保持大量 WebSocket 连接可能会占用较多服务器资源。
- 浏览器兼容性: 尽管大多数现代浏览器都支持 WebSocket，但仍需注意一些旧浏览器的兼容性。

# MQTT

MQTT（Message Queuing Telemetry Transport）是一种轻量级的发布/订阅（publish/subscribe）消息传输协议，专为低带宽、不可靠网络环境下的设备通信设计。它最早由IBM开发，目前由OASIS标准化组织维护。MQTT 常用于物联网（IoT）设备之间的通信。

MQTT 专为物联网设备设计，适用于低带宽、不可靠网络环境下的通信。它的轻量级和高效性使其成为物联网应用的理想选择。

发布/订阅模型简化了消息的分发，支持一对多的通信方式。发布者和订阅者之间的解耦合提高了系统的灵活性和可扩展性。

![](https://note-sun.oss-cn-shanghai.aliyuncs.com/image/202407260857500.png)

MQTT 的特点

- 轻量级: 协议头部非常小，适合资源受限的设备。
- 发布/订阅模型: 支持一对多的消息传递，简化了消息的分发。
- 可靠性: 提供三种服务质量（QoS）级别，确保消息的可靠传输。
- 持久化: 支持消息的持久化存储，确保在断开连接后消息不会丢失。
- 低带宽消耗: 设计用于低带宽、高延迟和不可靠的网络环境。

MQTT 采用客户端-服务器架构，主要包括以下组件：

- 客户端（Client）: 任何可以连接到MQTT代理（Broker）的设备或应用程序。客户端可以是发布者（Publisher）或订阅者（Subscriber）。
- 代理（Broker）: 负责接收、过滤和分发消息的服务器。

MQTT 提供三种服务质量级别，确保消息的可靠传输：

- QoS 0: 最多一次（At most once），消息可能会丢失或重复。
- QoS 1: 至少一次（At least once），消息可能会重复，但不会丢失。
- QoS 2: 只有一次（Exactly once），消息既不会丢失，也不会重复。

# MQ


微博用户数量庞大，特别是在热点事件发生时，瞬时并发量会急剧增加。例如，当某个明星发布新动态时，可能会有数千万用户同时在线并等待推送通知。

假设 CXK 发布了一条新微博，瞬间有 5000 万用户需要接收到推送通知。系统需要在极短时间内处理这 5000 万次推送请求，确保用户能够及时收到通知。这对系统的并发处理能力和稳定性提出了极高的要求。

