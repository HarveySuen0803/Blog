# Sentinel

Sentinel 通过 PING PANG 不断监控 Master 和 Slave 是否按预期工作. 如果 Master 故障了, Sentinel 会根据投票数将一个 Slave 转成 Master, 并通知 Client 最新的 Master IP 和 Slave IP 进行转移故障

Subjective Down, 单个 Sentinel 发送心跳给 Master, 一定时间内没有收到合法回复 (def. 30s), 就主观认定 Master 不可用

Objective Down, 超过指定数量的 Sentinel 都主观认为下线时, 就客观认定 master 不可用

Sentinel 认定 Master 为 Objective Down, 所有 Sentinel 根据 Raft Algo 选举一个 Sentinel 成为 Leader, 执行 Failover. Leader 根据 down-after-milliseconds, replica-priority, replication offset, run id 选择一个 Slave 成为 New Master. 等 Old Master 和 Slave 重启后, 会添加配置到 redis.conf 中, 让他们服从 New Master

- down-after-milliseconds 表示该 Slave 和 Master 失联的时长, 超过一定数值后, 直接排除
- replica-priority 越小, 优先级越高
- replication offset 表示复制的完整度, 越大优先级越高
- run id 是一串字符, 根据 ASCII 比较, 越小, 优先级越高

Cleft Brain 是指 Master, Slave 和 Sentinel 失联了, 处于不同的网络分区, Sentinel 无法感知 Master, 就会去从 Slave 中选举一个 New Master, 但是 Old Master 那边还在跟 Client 进行通信, 等网络恢复后, Old Master 会被降级为 Slave, 导致失联那会的数据丢失

解决 Cleft Brain, 设置 Master 最少连接的 Slave 数量, 如果小于该数值, 就认为该 Master 失联了, 就停止和 Client 进行通信

```shell
min-replicas-to-write 1
```

解决 Cleft Brain, 设置 Master 和 Slave 之间 Replication 的延迟, 如果大于该数值, 就认为该 Master 失联了, 就停止和 Client 进行通信

```shell
min-replicas-max-lag 5
```

# Sentinel Deployment

set master password (ip. 192.168.10.11, 192.168.10.12, 192.168.10.13; file. redis.conf)

```shell
masterauth "111"
```

set sentinel (ip. 192.168.10.14, 192.168.10.15, 192.168.10.16; file. sentinel.conf)

```shell
bind 0.0.0.0
daemonize yes
port 26379
protected-mode no
dir /home/harvey/data/redis
logfile "/home/harvey/data/redis/sentinel_26379.log"
pidfile /var/run/redis_sentinel_26379.pid

sentinel monitor my_master 192.168.10.11 6379 2
sentinel auth-pass my_master 111
sentinel down-after-milliseconds my_master 6000
sentinel failover-timeout my_master 180000
sentinel prallel-sync my_master 1
```

startup sentinel (ip. 192.168.10.14, 192.168.10.15, 192.168.10.16)

```shell
redis-sentinel config/redis/sentinel.conf
```

close sentinel

```shell
redis-cli -p 26379 -a 111 shutdown
```

check config generated by CONFIG REWRITE (file. sentinel.conf)

```shell
# Generated by CONFIG REWRITE
latency-tracking-info-percentiles 50 99 99.9
user default on sanitize-payload #f6e0a1e2ac41945a9aa7ff8a8aaa0cebc12a3bcc981a929ad5cf810a090e11ae ~* &* +@all
sentinel myid a4daf231c603627972891006a19e25db4363e500
sentinel config-epoch my_master 0
sentinel leader-epoch my_master 0
sentinel current-epoch 0

sentinel known-replica my_master 192.168.10.13 6379

sentinel known-replica my_master 192.168.10.12 6379

sentinel known-sentinel my_master 192.168.10.15 26379 cc7b816043c96dcf3cf552efffc8f9750757f838

sentinel known-sentinel my_master 192.168.10.16 26379 5b61d6090bfab239fb6dd0a385c59c2ddd3f4214
```

shutdown master to test sentinel

```shell
redis-cli -h 192.168.10.11 -p 6379 -a 111 shutdown
```

check replica

```shell
redis-cli -h 192.168.10.12 -p 6379 -a 111 shutdown
```

```
info replication
```

```shell
redis-cli -h 192.168.10.13 -p 6379 -a 111 shutdown
```

```
info replication
```

check config (ip. 192.168.10.11, 192.18.10.13; file. redis.conf)

```shell
# Generated by CONFIG REWRITE
save 3600 1
save 300 100
save 60 10000
replicaof 192.168.10.12 6379
latency-tracking-info-percentiles 50 99 99.9
user default on sanitize-payload
```

check sentinel log (ip. 192.168.10.14, 192.168.10.15, 192.168.10.16; file. sentinel.log)

```
Running mode=sentinel, port=26379.
Sentinel new configuration saved on disk
Sentinel ID is cc7b816043c96dcf3cf552efffc8f9750757f838
+monitor master my_master 192.168.10.11 6379 quorum 2
```

```
# add slave
+slave slave 192.168.10.12:6379 192.168.10.12 6379 @ my_master 192.168.10.11 6379
Sentinel new configuration saved on disk

# add slave
+slave slave 192.168.10.13:6379 192.168.10.13 6379 @ my_master 192.168.10.11 6379
Sentinel new configuration saved on disk

# add sentinel
+sentinel sentinel a4daf231c603627972891006a19e25db4363e500 192.168.10.15 26379 @ my_master 192.168.10.11 6379
Sentinel new configuration saved on disk

# add sentinel
+sentinel sentinel 5b61d6090bfab239fb6dd0a385c59c2ddd3f4214 192.168.10.16 26379 @ my_master 192.168.10.11 6379
Sentinel new configuration saved on disk
```

```
# master failed ...

# subject down
+sdown master my_master 192.168.10.11 6379

# object down
+odown master my_master 192.168.10.11 6379 #quorum 2/2

# new epoch
+new-epoch 1

# try failover
+try-failover master my_master 192.168.10.11 6379
Sentinel new configuration saved on disk

# vote for leader
+vote-for-leader cc7b816043c96dcf3cf552efffc8f9750757f838 1
a4daf231c603627972891006a19e25db4363e500 voted for cc7b816043c96dcf3cf552efffc8f9750757f838 1
5b61d6090bfab239fb6dd0a385c59c2ddd3f4214 voted for cc7b816043c96dcf3cf552efffc8f9750757f838 1

# elect master
+elected-leader master my_master 192.168.10.11 6379

# failover
+failover-state-select-slave master my_master 192.168.10.11 6379

# select slave
+selected-slave slave 192.168.10.12:6379 192.168.10.12 6379 @ my_master 192.168.10.11 6379

# failover
+failover-state-send-slaveof-noone slave 192.168.10.12:6379 192.168.10.12 6379 @ my_master 192.168.10.11 6379
+failover-state-wait-promotion slave 192.168.10.12:6379 192.168.10.12 6379 @ my_master 192.168.10.11 6379
Sentinel new configuration saved on disk
+promoted-slave slave 192.168.10.12:6379 192.168.10.12 6379 @ my_master 192.168.10.11 6379
+failover-state-reconf-slaves master my_master 192.168.10.11 6379
+slave-reconf-sent slave 192.168.10.13:6379 192.168.10.13 6379 @ my_master 192.168.10.11 6379
-odown master my_master 192.168.10.11 6379
+slave-reconf-inprog slave 192.168.10.13:6379 192.168.10.13 6379 @ my_master 192.168.10.11 6379
+slave-reconf-done slave 192.168.10.13:6379 192.168.10.13 6379 @ my_master 192.168.10.11 6379
+failover-end master my_master 192.168.10.11 6379

# switch master from  192.168.10.11:6379 to 192.168.10.12:6379
+switch-master my_master 192.168.10.11 6379 192.168.10.12 6379
+slave slave 192.168.10.13:6379 192.168.10.13 6379 @ my_master 192.168.10.12 6379
+slave slave 192.168.10.11:6379 192.168.10.11 6379 @ my_master 192.168.10.12 6379
Sentinel new configuration saved on disk
+sdown slave 192.168.10.11:6379 192.168.10.11 6379 @ my_master 192.168.10.12 6379
```
